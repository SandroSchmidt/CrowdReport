<!DOCTYPE html>
<html>

<head>
  <title>SS23 crowd-report</title>

  <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.3/firebase-database.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.js"></script>

</head>

<body>
  <div style="width:100%;height:100%;overflow:hidden">
  <div id="map_div" style="width:100%;height:500px; background-color: rgb(43, 128, 226);"></div>

  
  <table style="width:100%">
    <tr><td>reporting:</td>
      <td><input type="text" value="Meldender" style="width:100%" onchange="set_name=this.value;console.log('meldender geÃ¤ndert auf: '+set_name)">
      </td>
      <td>unlocked</td>
    </tr>
    <tr>
      <td>dens:</td>
      <td> <input type="range" id="numberInput" name="numberInput" min="0" max="10" value =5  onchange="set_dens= parseInt(this.value);d3.select('#dens_p').text(set_dens)"></td>
    <td> <span id="dens_p"> 5</span></td>
    </tr>
    <tr>
<td>tens:</td>
<td>   <input type="range" id="numberInput2" name="numberInput" min="0" max="10" value =5  onchange="set_tens= parseInt(this.value);d3.select('#tens_p').text(set_tens)"></td>
 <td> <span id="tens_p"> 5</span></td>

    </tr>

    <tr>
      <td>usage:</td>
      <td><input type="range" id="numberInput3" name="numberInput" min="0" max="100" step=5 value =50 onchange="set_usage= parseInt(this.value);d3.select('#usage_p').text(set_usage + ' %')">
      </td>
      <td>  <span id="usage_p"> 10%</span></td>
    </tr>

    <tr>
      <td>zone:</td>
      <td><select id="dropdown" name="dropdown" onchange="set_area = parseInt(this.value);">

  </select></td>
      <td><button onclick="writeToFirebase()">Send report</button></td>
    </tr>
  </table>
  

 

  <hr>
  <p id="infotag">loaded</p>
 <hr>
</div>
  wo bleibt das commit?
</body>

<script>
set_area=0
    farbskala =
         ["lightblue","lightblue",
            "#00B0F0","#00B0F0",
            "#92D050","#92D050",
            "#FFFF00","#FFFF00",
            ,"#FF9201","#FF9201",
            ,"#FF0000",'red','red','red','red','red','red','red','red','red','red']
stages=[{geo:"",dens:0,usage:0,tens:0,title:"bigbeast",coords:[
            [50.958411347755174,
              6.962090532208862
              
            ],
            [       50.956149878628054,
              6.960614558879342
       
            ],
            [ 50.95363700607018,
              6.9650424788679
             
            ],
            [       50.955471416428225,
              6.970587351646884
       
            ],
            [50.958134951877014,
              6.966079649316782
              
            ],
            [     50.958411347755174,
              6.962090532208862
         
            ]
          ]
        },  {geo:"",dens:0,usage:0,tens:0,title:"vendor",coords:[
            [50.95753190069374,
              6.9568647887585655
              
            ],
            [   50.95418984986867,
              6.946058701413818
           
            ],
            [50.950897820385705,
              6.945899136729281
              
            ],
            [    50.95431549522897,
              6.956709644091092
          
            ],
            [         50.95577295658401,
              6.957746814538467
     
            ],
            [  50.95753190069374,
              6.9568647887585655
            
            ]
          ]}
       ,
       {geo:"",dens:0,usage:0,tens:0,title:"downbeast",coords:[
            [50.954114462489514,
              6.963610816686554
              
            ],
            [    50.9514255659968,
              6.959103114354974
          
            ],
            [ 50.945997039251495,
              6.957028773458717
             
            ],
            [     50.94504195507878,
              6.955353344273163
         
            ],
            [50.9447906149085,
              6.956191059400055
              
            ],
            [  50.94602713248548,
              6.957838401697558
            
            ],
            [  50.95127974129281,
              6.959673395566227
            
            ],
            [ 50.95127974129281,
              6.963610816686554
               
            ]
          ]
        }]

        for(i=0;i<stages.length;i++){
    d3.select('#dropdown').append('option').attr('value',i).text(stages[i].title)
    }

// hohlt die eigene pos vom browser
update_ownpos()
// wiederholt alle 10 sek 
setInterval(function() {
 update_ownpos()
// read_current()
  }, 6000);


// hohlt die eigene pos vom browser
function update_ownpos(){
  navigator.geolocation.getCurrentPosition(
            (position) => {
                // Extract latitude and longitude from the position object
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
             set_pos =[latitude,longitude]
             set_pos=[50.958411347755174,6.962090532208862] 
              // das hier muss weg wenn wir vor ort sind, das ist der platzhalter wenn mann von woanders ausprobieren will

    mymap.setView(set_pos)
    ownmarker.setLatLng(set_pos)
              // Displnay the user's position information
             //  console.log(`Latitude: ${latitude}, Longitude: ${longitude}`)
            },
            (error) => {
                // Handle any errors that occur during geolocation
                console.log(`Error: ${error.message}`)
            }
         
        );
        a = new Date()
        d3.select('#infotag').text('status: own loc upt at '+ a.getHours()+":"+a.getMinutes()+":"+a.getSeconds())
}
   

const firebaseConfig = {
        apiKey: "AIzaSyBOOdW1SHCwBZSchUJ7DfJZ1a7-dEYTvuQ",
        authDomain: "crowdcount-678c8.firebaseapp.com",
        databaseURL: "https://crowdcount-678c8-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "crowdcount-678c8",
        storageBucket: "crowdcount-678c8.appspot.com",
        messagingSenderId: "1020533758948",
        appId: "1:1020533758948:web:23ec6e175dff3b5eedc5f1",
        measurementId: "G-00674BETEZ"
        };

  set_pos =[0,0];
  set_name ="ds"
  //set_area="bigbeast"
  set_dens=0
  set_tens = 0
  set_usage=0
  current=0
//zu
  function read_current (){

    database = firebase.database();
  
const ref = database.ref('/soundstorm/aktuell');

ref.once('value', (snapshot) => {

  current = snapshot.val()
  

});

for(i=0;i<stages.length;i++){
   
   // temp = current[stages[i].title]
   // fcol = farbskala[Math.round(temp.usage/10)]
   // col = farbskala[temp.density]
   // console.log(temp.dens)
    stages[i].geo.setStyle({
       opacity:1,
        fillOpacity:0.6,
        fillColor: fcol,
        color: col,
        "weight": 5
  })
}


  }

  var mymap = L.map('map_div',{zoomSnap: 0.1, dragging: false}).setView(set_pos,15 )
 //        mymap.on('zoomend', function() {setviewzoom = mymap.getZoom()});
   //   mymap.on('moveend', function() { mapaa = (mymap.getCenter(),mymap.getCenter());setviewmap=[mapaa.lat,mapaa.lng]});
   L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      
     // opacity: 0.5,
      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    }).addTo(mymap);

    ownmarker = L.marker(set_pos).addTo(mymap);
    let touchStartX, touchEndX;

mymap.getContainer().addEventListener("touchstart", function (e) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    start_time = new Date()
});

// hier werden die swipes aufgenommen und gespeichert in der firebase  
mymap.getContainer().addEventListener("touchend", function (e) {
    touchEndX = e.changedTouches[0].clientX;
    touchEndY = e.changedTouches[0].clientY;
    ort1 = mymap.containerPointToLatLng([touchStartX,touchStartY]);
    ort2 = mymap.containerPointToLatLng([touchEndX,touchEndY]);
    minmove = 0.005
   if((Math.abs(ort1.lat - ort2.lat) + Math.abs(ort1.lng - ort2.lng)) > minmove)
   { end_date = new Date()
   
    diff = (end_date.getTime()-start_time.getTime())/1000
    www = 10*(0.5+diff)
       const database = firebase.database()
       var polyline = L.polyline([ort1,ort2],{weight:www}).addTo(mymap);

       var arrowHead = L.polylineDecorator(polyline, {
    patterns: [
      { offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({ pixelSize: 30, polygon: false, pathOptions: { fillOpacity: 1, weight:www } }) }
    ]
  }).addTo(mymap);

  setTimeout(function () {
    mymap.removeLayer(polyline);
    mymap.removeLayer(arrowHead);
  }, 10000);

    ntemp = new Date()
    ntemp = ntemp.getTime()
    databaseRef = database.ref('soundstorm').child('swipes').child(ntemp);
        databaseRef.set({meldender:set_name,von:ort1, nach:ort2,zeit:ntemp,dicke:www})
}
  })
stages_geo=[]
//ff
  for(i=0;i<stages.length;i++)
{let zi =i 
  f= L.polygon(stages[i].coords, {color: 'red'}).on('click',function(){
  this.setStyle({color:"green"})
  set_area=stages[zi].title;d3.select('#dropdown').property('value',zi)

 
  }).addTo(mymap)

  stages[i].geo = f
}
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    // Function to write data to the Firebase database
    function writeToFirebase() {


      jetzt = new Date()
      
      const database = firebase.database();

      // Replace 'your-data' with the path where you want to write the data in the database
      // For example, if you want to write data to 'https://your-project-id.firebaseio.com/users', use 'users'
       databaseRef = database.ref('soundstorm').child('SS23').child(jetzt.getTime());

      // Data you want to write to the database



      const dataToWrite = {
        zeit: jetzt.getTime(),
        name: set_name,
        area: set_area,
        density: set_dens,
        position: set_pos,
        tension: set_tens,
        usage: set_usage,
      };

     // Push the data to the database
      databaseRef.set(dataToWrite)
        .then(() => {
          console.log("Data was successfully written to the Firebase database.");
        })
        .catch((error) => {
          console.error("Error writing data to the Firebase database:", error);
        });

        d3.select('#infotag').text('status: report sent at '+ a.getHours()+":"+a.getMinutes()+":"+a.getSeconds())

        // hier wird versucht zusÃ¤tzlich einen report Ã¼ber die aktuelle alge zusammenzustellen
        databaseRef = database.ref('soundstorm').child('aktuell').child(stages[set_area].title);
        databaseRef.set({zeit:jetzt.getTime(), density: set_dens, tension: set_tens,  usage: set_usage})
    }

    
  

  </script>

</html>
