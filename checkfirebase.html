<!DOCTYPE html>
<html>

<head>
  <title>SS23 crowd-report</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator/dist/leaflet.polylineDecorator.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="./data.js"></script>
 
  <!--
   <script src="./js/d3.min.js"></script>
  <script src="./js/leaflet.js"></script>
  <link rel="stylesheet" type="text/css" href="./js/leaflet.css" />


  -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
  <div style="width:100%;height:100%;overflow:hidden">
 

</div>
 
</body>

<script>
  
    initialise_firebase()
    read_current()
   // update_ownpos()

setInterval(function() {

read_current()
  }, 5000);


  index.html678c8.firebaseapp.com",
        databaseURL: "https://crowdcount-678c8-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "crowdcount-678c8",
        storageBucket: "crowdcount-678c8.appspot.com",
        messagingSenderId: "1020533758948",
        appId: "1:1020533758948:web:23ec6e175dff3b5eedc5f1",
        measurementId: "G-00674BETEZ"
        };
// Initialize Firebase
firebase.initializeApp(firebaseConfig);


      }  
function read_current (){

    database = firebase.database();
  
const ref = database.ref('/soundstorm/aktuell');

ref.once('value', (snapshot) => {

  current = snapshot.val()
  
});

for(i=0;i<stages_list.length;i++){
   if(current[stages_list[i].name] != undefined){
    temp = current[stages_list[i].name]

    fcol = farbskala[Math.round(temp.usage)]
    col = farbskala[Math.round(temp.density)]
    stages_list[i].geo.setStyle({
       opacity:1,
        fillOpacity:0.6,
        fillColor: fcol,
        color: col,
        "weight": 4
  })}
}


  }
function select_area(areanumber){
    ausgew_area = stages_list[areanumber].name
          d3.select('#densInput').attr('value',current[ausgew_area].density)
          d3.select('#dens_p').text(current[ausgew_area].density)

          d3.select('#tensInput').attr('value',current[ausgew_area].tension)
          d3.select('#tens_p').text(current[ausgew_area].tension)

          d3.select('#usageInput').attr('value',current[ausgew_area].usage)
          d3.select('#usage_p').text(current[ausgew_area].usage+" %")

          //dens_slider.node().dispatchEvent(new Event('input'));

  }
function initialise_map(){

  // Karte und Hintergründe
  var mymap = L.map('map_div',{zoomSnap: 0.1, dragging: false}).setView([24.997496213866462,46.51234272528364],15 )
   // mymap.on('zoomend', function() {setviewzoom = mymap.getZoom()});
   // mymap.on('moveend', function() { mapaa = (mymap.getCenter(),mymap.getCenter());setviewmap=[mapaa.lat,mapaa.lng]});

tl1= L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{      
      opacity: 0.5,      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    }).addTo(mymap);

var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    })

var Jawg_Matrix =  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
	subdomains: 'abcd',
	maxZoom: 20
});

const imageUrl = './map1.png';
// Define the bounds of the image
const imageBounds = [ [25.013,46.4805],[24.988092848232725, 46.53216767460525]];
const imageOverlay = L.imageOverlay(imageUrl, imageBounds);

stages_layer = L.layerGroup().addTo(mymap)
green_layer = L.layerGroup().addTo(mymap)

// alles einmalen das keine Bühnen sind
for (f=0;f<parking_arr.length;f++)  {L.polygon(parking_arr[f], {color: 'blue'}).addTo(mymap)}
for (f=0;f<walking_arr.length;f++)  {L.polygon(walking_arr[f], {color: 'grey'}).addTo(green_layer)}
for (f=0;f<greening_arr.length;f++) {L.polygon(greening_arr[f], {color: 'green'}).addTo(green_layer)}
for (f=0;f<blocking_arr.length;f++) {L.polygon(blocking_arr[f], {color: 'grey'}).addTo(green_layer)}
for (f=0;f<hinter.length;f++)       {L.polygon(hinter[f], {color: 'grey'}).addTo(green_layer)}
for (f=0;f<vib_arr.length;f++)      {L.polygon(vib_arr[f], {color: 'gold'}).addTo(mymap)}

// Layercontroll
L.control.layers(
  {"OSM": tl1,"img": imageOverlay,"dark":Jawg_Matrix ,"sat":Esri_WorldImagery},
  {"stages":stages_layer,"blocks":green_layer}).addTo(mymap);

ownmarker = L.marker(  [24.996,46.508]).addTo(mymap);

// Swipefunktion
    let touchStartX, touchEndX;

mymap.getContainer().addEventListener("touchstart", function (e) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    start_time = new Date()
});

mymap.on('zoomlevelschange', function () {
    // This event is triggered when the zoom level changes (e.g., button press)
    // You can handle button press logic here
    isZooming = true;
    setTimeout(function () {
isZooming = false
  }, 200);
});

mymap.on('zoomstart', function() {
    isZooming = true;
});

mymap.on('zoomend', function() {
    isZooming = false;
});

// hier werden die swipes aufgenommen und gespeichert in der firebase  
mymap.getContainer().addEventListener("touchend", function (e) {
  if(!isZooming){
    touchEndX = e.changedTouches[0].clientX;
    touchEndY = e.changedTouches[0].clientY;
    ort1 = mymap.containerPointToLatLng([touchStartX,touchStartY]);
    ort2 = mymap.containerPointToLatLng([touchEndX,touchEndY]);

    minmove = 0.001
    maxmove = 0.01
    move = Math.abs(ort1.lat - ort2.lat) + Math.abs(ort1.lng - ort2.lng)
    
   if(move> minmove && move <maxmove)
   { end_date = new Date()   
    diff = (end_date.getTime()-start_time.getTime())/1000
    www = 10*(0.5+diff)
      
  //malen des Swipes und des Pfeilkopfes
      var polyline = L.polyline([ort1,ort2],{weight:www}).addTo(mymap);
      var arrowHead = L.polylineDecorator(polyline, {    patterns: [      { offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({ pixelSize: 30, polygon: false, pathOptions: { fillOpacity: 1, weight:www } }) }    ]}).addTo(mymap);
      infotag.text("swipe gespeichert!"+ diff)

  // timeer der eingegebene Swipes vernichtet
  setTimeout(function () {
    mymap.removeLayer(polyline);
    mymap.removeLayer(arrowHead);
  }, 5000);

    ntemp = new Date()
    ntemp = ntemp.getTime()

    // !!!! hier sit das speichern des swipes deaktiviert !!!!!!!!!!!!
     const database = firebase.database()
     databaseRef = database.ref('soundstorm').child('swipes').child(ntemp);
    databaseRef.set({meldender:set_name,von:ort1, nach:ort2,zeit:ntemp,dicke:www})
    }
  }})

// Bühnen einmalen
stages_geo=[]
for(i=0;i<stages_list.length;i++)
{if(stages_list[i].coords != "donotdraw"){
  let zi =i 
  f = L.polygon(stages_list[i].coords, {color: '#99ff66'})
      //.on('mouseover',function(){this.setStyle({color:"red"})})
      .on('click',function(){
      // this.setStyle({color:"green"})
      select_area(zi)
      set_area=zi;d3.select('#dropdown').property('value',zi)
  }).addTo(stages_layer)
  stages_list[i].geo = f
}}}

function writeReportToFirebase() {
      jetzt = new Date()
   
      const database = firebase.database();
      // Replace 'your-data' with the path where you want to write the data in the database
      // For example, if you want to write data to 'https://your-project-id.firebaseio.com/users', use 'users'
       databaseRef = database.ref('soundstorm').child('SS23').child(jetzt.getTime());
      // Data you want to write to the database

      const dataToWrite = {
        zeit: jetzt.getTime(),
        name: set_name,
        area: set_area,
        density: set_dens,
        position: set_pos,
        tension: set_tens,
        usage: set_usage,
      };

     // Push the data to the database
      databaseRef.set(dataToWrite)
        .then(() => {
          console.log("Data was successfully written to the Firebase database.");
        })
        .catch((error) => {
          console.error("Error writing data to the Firebase database:", error);
        });

        d3.select('#infotag').text('status: report sent at '+ jetzt.getHours()+":"+jetzt.getMinutes()+":"+jetzt.getSeconds())

        // hier wird versucht zusätzlich einen report über die aktuelle alge zusammenzustellen

       
        databaseRef = database.ref('soundstorm').child('aktuell').child(stages_list[set_area].name);
        databaseRef.set({zeit:jetzt.getTime(), density: set_dens, tension: set_tens,  usage: set_usage})

        read_current()
    }

    
  

  </script>

</html>
